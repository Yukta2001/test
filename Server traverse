import paramiko

# Function to establish SSH connection
def establish_ssh_connection(hostname, port, username, password):
    try:
        # Create a new SSH client
        client = paramiko.SSHClient()

        # Automatically add host keys
        client.set_missing_host_key_policy(paramiko.AutoAddPolicy())

        # Connect to the server
        client.connect(hostname, port, username, password)

        print("Connected to the server successfully!")

        return client

    except paramiko.AuthenticationException:
        print("Authentication failed, please verify your username and password.")
    except paramiko.SSHException as e:
        print("SSH connection failed:", e)

    return None

# Function to switch to root user
def switch_to_root_user(ssh_client):
    try:
        # Execute command to switch to root user
        stdin, stdout, stderr = ssh_client.exec_command('sudo su -')

        # Check if the command executed successfully
        if stderr.channel.recv_exit_status() != 0:
            print("Failed to switch to root user:", stderr.read().decode())
            return False

        print("Switched to root user successfully!")
        return True

    except Exception as e:
        print("Error:", e)
        return False

# Server credentials
hostname = 'your_server_hostname'
port = 22  # default SSH port
username = 'your_KPMG_username'
password = 'your_KPMG_password'

# Establish SSH connection as KPMG user
ssh_client = establish_ssh_connection(hostname, port, username, password)

if ssh_client:
    try:
        # Switch to root user
        if switch_to_root_user(ssh_client):
            # Get current directory path
            stdin, stdout, stderr = ssh_client.exec_command('pwd')
            current_directory = stdout.read().decode().strip()
            print("Current directory path:", current_directory)

            # List all folders in the current directory
            stdin, stdout, stderr = ssh_client.exec_command('ls -d */')
            folders = stdout.read().decode().split()
            print("Folders in the current directory:")
            for folder in folders:
                print(folder)

    finally:
        # Close the SSH connection
        ssh_client.close()
